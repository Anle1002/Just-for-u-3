<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Hand - Nắm & Mở</title>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Arial, sans-serif; }
        #bg-image { position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; filter: brightness(0.2) blur(8px); z-index: -1; }
        #start-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; transition: 0.8s; text-align: center; }
        #start-btn { padding: 18px 45px; border-radius: 40px; border: 2px solid #f1c40f; background: rgba(241, 196, 15, 0.1); color: #f1c40f; font-size: 1.3rem; cursor: pointer; transition: 0.3s; font-weight: bold; }
        #ui-layer { position: absolute; top: 30px; width: 100%; text-align: center; color: white; pointer-events: none; z-index: 10; }
        #instructions { background: rgba(255, 255, 255, 0.1); padding: 12px 25px; border-radius: 30px; backdrop-filter: blur(5px); opacity: 0; border: 1px solid rgba(255,255,255,0.2); }
        #video-container { position: absolute; bottom: 20px; right: 20px; width: 160px; height: 120px; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #yt-player-container { position: absolute; top: -1000px; left: -1000px; }
    </style>
</head>
<body>

    <div id="bg-image"></div>
    <div id="yt-player-container"><div id="player"></div></div>

    <div id="start-overlay">
        <h1>Phép Màu Trong Tầm Tay</h1>
        <p style="margin-bottom: 30px; color: #aaa;">Nắm tay để gom cây thông • Xòe tay để tung ngân hà</p>
        <button id="start-btn">Bắt Đầu</button>
    </div>

    <div id="ui-layer">
        <div id="instructions">NẮM TAY lại để lắp ráp cây thông!</div>
    </div>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <script>
        const PARTICLE_COUNT = 10000;
        let scene, camera, renderer, particles, starGroup, ytPlayer;
        let handTracker, videoElement;
        let assemblyFactor = 0, targetAssembly = 0, handPositions = [];

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('player', {
                height: '0', width: '0', videoId: '6ag__ntUafU',
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': '6ag__ntUafU' }
            });
        }

        document.getElementById('start-btn').onclick = function() {
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 800);
            if (ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo();
            gsap.to("#instructions", { opacity: 1, duration: 2 });
            init();
        };

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 6;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            createTreeParticles();
            createTopStar();
            await setupMediaPipe();
            gsap.ticker.add(render);
            window.addEventListener('resize', onWindowResize);
        }

        function createTreeParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(PARTICLE_COUNT * 3), tar = new Float32Array(PARTICLE_COUNT * 3);
            const chos = new Float32Array(PARTICLE_COUNT * 3), cols = new Float32Array(PARTICLE_COUNT * 3);

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const r = Math.random(), h = Math.random() * 5 - 2.5, rad = ((2.5-h)/5)*2, ang = Math.random()*Math.PI*2;
                tar[i*3] = Math.cos(ang)*rad*r; tar[i*3+1] = h; tar[i*3+2] = Math.sin(ang)*rad*r;
                const d = 4 + Math.random()*5, a = Math.random()*Math.PI*2;
                chos[i*3] = Math.cos(a)*d; chos[i*3+1] = (Math.random()-0.5)*6; chos[i*3+2] = Math.sin(a)*d;
                const c = new THREE.Color().setHSL(0.3 + Math.random()*0.1, 0.8, 0.4 + Math.random()*0.3);
                if(Math.random() > 0.85) c.setHex(0xffd700); 
                cols[i*3] = c.r; cols[i*3+1] = c.g; cols[i*3+2] = c.b;
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('target', new THREE.BufferAttribute(tar, 3));
            geo.setAttribute('chaos', new THREE.BufferAttribute(chos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(cols, 3));
            particles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.035, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true }));
            scene.add(particles);
        }

        function createTopStar() {
            starGroup = new THREE.Group();
            starGroup.add(new THREE.Mesh(new THREE.OctahedronGeometry(0.35, 0), new THREE.MeshBasicMaterial({ color: 0xffd700, transparent: true, opacity: 0 })));
            starGroup.position.y = 2.75;
            scene.add(starGroup);
        }

        async function setupMediaPipe() {
            videoElement = document.getElementById('webcam');
            handTracker = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            handTracker.setOptions({ maxNumHands: 1, modelComplexity: 1 }); // Chỉ cần 1 tay để điều khiển cho dễ
            handTracker.onResults(onHandResults);
            new Camera(videoElement, { onFrame: async () => await handTracker.send({ image: videoElement }), width: 640, height: 480 }).start();
        }

        function onHandResults(results) {
            handPositions = [];
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // KIỂM TRA TRẠNG THÁI NẮM TAY
                // Nếu đầu ngón tay (8, 12, 16, 20) thấp hơn khớp giữa (6, 10, 14, 18) -> Nắm tay
                const isFist = landmarks[8].y > landmarks[6].y && 
                               landmarks[12].y > landmarks[10].y && 
                               landmarks[16].y > landmarks[14].y;

                targetAssembly = isFist ? 1 : 0;

                // Cập nhật hướng dẫn
                const ins = document.getElementById('instructions');
                ins.innerHTML = isFist ? "Đang giữ cây thông..." : "Xòe tay để tung ngân hà!";

                handPositions.push(new THREE.Vector3((landmarks[8].x-0.5)*-12, (landmarks[8].y-0.5)*-8, 0));
            } else {
                targetAssembly = 0;
            }
        }

        function render() {
            assemblyFactor = THREE.MathUtils.lerp(assemblyFactor, targetAssembly, 0.08);
            if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(20 + assemblyFactor * 60);

            const p = particles.geometry.attributes.position, t = particles.geometry.attributes.target, c = particles.geometry.attributes.chaos;
            const time = Date.now() * 0.001;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const ix=i*3, iy=i*3+1, iz=i*3+2;
                const ang = time * 0.2 + (i * 0.001), rad = Math.sqrt(c.array[ix]**2 + c.array[iz]**2);
                
                let dx = THREE.MathUtils.lerp(Math.cos(ang)*rad, t.array[ix], assemblyFactor);
                let dy = THREE.MathUtils.lerp(c.array[iy], t.array[iy], assemblyFactor);
                let dz = THREE.MathUtils.lerp(Math.sin(ang)*rad, t.array[iz], assemblyFactor);

                // Hiệu ứng vuốt khi xòe tay
                if (assemblyFactor < 0.5) {
                    handPositions.forEach(h => {
                        const dist = Math.sqrt((dx-h.x)**2 + (dy-h.y)**2);
                        if(dist < 2.0) { dx += (dx-h.x)*(2.0-dist)*0.3; dy += (dy-h.y)*(2.0-dist)*0.3; }
                    });
                }

                p.array[ix]=dx; p.array[iy]=dy; p.array[iz]=dz;
            }
            p.needsUpdate = true;
            particles.rotation.y += 0.002;
            if(starGroup) { 
                starGroup.scale.setScalar(assemblyFactor); 
                starGroup.children[0].material.opacity = assemblyFactor;
                starGroup.rotation.y += 0.05;
            }
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>